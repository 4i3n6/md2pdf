name: Release Please

on:
  push:
    branches:
      - main

permissions:
  contents: write
  pull-requests: write

jobs:
  release-please:
    runs-on: ubuntu-latest
    steps:
      - uses: googleapis/release-please-action@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          config-file: release-please-config.json
          manifest-file: .release-please-manifest.json

  auto-merge:
    needs: release-please
    runs-on: ubuntu-latest
    steps:
      - name: Merge pending release PR
        run: |
          PR=$(gh pr list \
            --repo 4i3n6/md2pdf \
            --label "autorelease: pending" \
            --state open \
            --json number \
            --jq '.[0].number // empty')
          if [ -n "$PR" ]; then
            gh pr merge "$PR" --merge --auto --repo 4i3n6/md2pdf
            echo "Queued auto-merge for release PR #$PR"
          else
            echo "No pending release PR â€” skipping"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
