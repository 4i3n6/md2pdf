#!/bin/sh
# pre-commit — enforces author identity and bumps version on every commit.
# Configured via: git config core.hooksPath .githooks

REQUIRED_NAME="4i3n6"
REQUIRED_EMAIL="4i3n6@pm.me"

AUTHOR_NAME=$(git config user.name)
AUTHOR_EMAIL=$(git config user.email)

if [ "$AUTHOR_NAME" != "$REQUIRED_NAME" ] || [ "$AUTHOR_EMAIL" != "$REQUIRED_EMAIL" ]; then
    echo ""
    echo "ERROR: Commits to this repository must be authored by $REQUIRED_NAME <$REQUIRED_EMAIL>"
    echo "Current identity: $AUTHOR_NAME <$AUTHOR_EMAIL>"
    echo ""
    echo "Fix with:"
    echo "  git config user.name '$REQUIRED_NAME'"
    echo "  git config user.email '$REQUIRED_EMAIL'"
    echo ""
    exit 1
fi

STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | \
    grep -Ev "^(package\.json|package-lock\.json|src/i18n/en\.ts|src/i18n/pt\.ts|app\.html|pt/app\.html|scripts/bump-version\.mjs)$")

if [ -n "$STAGED_FILES" ]; then
    echo "[pre-commit] Bumping version..."

    node scripts/bump-version.mjs patch
    if [ $? -ne 0 ]; then
        echo "[pre-commit] ERROR: version bump failed — aborting commit"
        exit 1
    fi

    git add package.json package-lock.json \
        src/i18n/en.ts src/i18n/pt.ts \
        app.html pt/app.html

    echo "[pre-commit] Version bumped and staged"
fi

exit 0
